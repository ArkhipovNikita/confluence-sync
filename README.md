# ConfluenceSync

CLI-утилита для копирования страниц из одного конфлюенса в другой.

## Функционал

- Копируется вся иерархия страницы;
- Копируются все вложения страницы, если вложение уже существует в конфлюенсе назначения, то копирование происходит,
  только если оно было изменено;
- Копируются drawio диаграммы, даже если исходник находится вне текущей иерархии;
- Если drawio диаграмма ссылается на другую, то ссылка будет изменена на новую страницу;
- Версии страницы не копируются – при каждой синхронизации создается одна версия, сколько бы версий не было в исходной
  странице, например, было 3 версии, стала 1;
- При копировании новая версия страницы не создается, если содержимое не было изменено;
- При копировании проверяются ссылки на другие страницы – если ссылка ведет страницу, которая находится вне иерархии
  текущей, то отображается сообщение об этом;
- При копировании можно переименовывать страницы – указать какую часть заголовка на что заменить или добавить префикс к
  заголовку.

## Параметры

| Название                 | Описание                                      | Пример                         |
|:-------------------------|-----------------------------------------------|--------------------------------|
| `--source-url`           | URL исходного конфлюенса                      | `"https://confluence.cyrm.ru"` |
| `--source-token`         | PAT-токен авторизации исходного конфлюенса    | `""`                           |
| `--source-basic`         | Логин / пароль исходного конфлюенса           | `"username:password"`          |
| `--source-space`         | Название исходного пространства               | `"MP"`                         |
| `--source-title`         | Название исходной страницы в пространстве     | `""`                           |
| `--dest-url`             | URL конфлюенса назначения                     | `"https://confluence.zxz.su"`  |
| `--dest-token`           | PAT-токен авторизации конфлюенса назначения   | `""`                           |
| `--dest-basic`           | Логин / пароль конфлюенса назначения          | `"username:password"`          |
| `--dest-space`           | Название пространства назначения              | `"UVP"`                        |
| `--dest-title`           | Название страницы назначения                  | `""`                           |
| `--replace-title-substr` | Замена подстроки заголовка страницы на другую | `"[int_ЕВП]" "[test_ЕВП]"`     |
| `--start-title-with`     | Добавление префикса к заголовку страницы      | `"PY "`                        |

## Установка и использование

Минимальная версия python 3.11.
Пакет лежит `nexus.cyrm.tech` в репозитории `pypi-cyrm-proxy`, установить можно следующей командой:

```bash
pip install -i https://nexus.cyrm.tech/repository/pypi-cyrm-proxy/simple confluence-sync
```

Использовать утилиту можно следующей командой:

```bash
python -m confluence_sync
```

Хелп: 

```bash
python -m confluence_sync -h
```

## Публикация пакета

1. Изменить версию в [pyproject.toml](pyproject.toml) (следовать [семантическому](https://semver.org/spec/v2.0.0.html) версионированию)

2. Сбилдить пакет 

    ```bash
    poetry build
     ``` 

3. Добавить репозиторий `pypi-cyrm` в poetry

    ```bash
    poetry config repositories.cyrm https://nexus.cyrm.tech/repository/pypi-cyrm/
    ```

4. Опубликовать пакет

    ```bash
    poetry publish -r cyrm
    ```

## Бэклог

- [ ] Добавить обработку ошибок клиента `atlassian.Confluence` и информирование об этом в cli
- [ ] Синхронизировать только обновленные с предыдущего раза или новые страницы
- [ ] Добавить grace shutdown
- [ ] Проверить запуск синхронизации страницы несколько раз с одним экземпляром класса
- [ ] Добавить CI/CD для публикации пакета по тегу
- [ ] Выделить в отдельную сущность работу с объектами страницы, например,` get_inc_drawio_macros`, `get_name_param`. Пример поиска нужных [элементов](https://lxml.de/element_classes.html#default-class-lookup).
- [ ] Добавить xpath builder
- [ ] Убрать проксирование методов `etree._Element` только для проставления namespace, попробовать сделать так, чтобы элементы сами знали о них.
- [ ] При запросе определенных вложений страницы не считывать все.
- [ ] Добавить автотесты для проверки функционала drawio диаграмм ([пример](https://confluence.cyrm.ru/display/~n.arkhipov@cyrm.ru/IncDrawio) страниц):
  - Копирование внешней диаграммы
  - Копирование внешней диаграммы и ссылка на нее в другой странице на том же уровне
  - Копирование внешней диаграммы и ссылка на нее в другой странице ниже уровнем
  - Изменение ссылки в диаграмме, что ссылается на диаграмму страницей выше 
  - Изменение ссылки в диаграмме, что ссылается на диаграмму страницей ниже
  - Изменение ссылки в диаграмме, что ссылается на диаграмму на странице того же уровня
